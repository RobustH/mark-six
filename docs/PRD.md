这是为您更新后的 PRD v2.3 版本。主要变更在于新增了 **6.2 历史开奖统计模块**，并对后续章节序号和 MVP 范围进行了相应的调整。

---

# 📱 六合彩量化回测与策略验证平台 PRD v2.3

| **文档属性** | **详细信息** |
| --- | --- |
| **产品名称** | 六合彩量化回测与策略验证平台 |
| **当前版本** | **v2.5** |
| **更新时间** | 2026-01-19 |
| **文档状态** | ✅ 已审核 |

---

## 0. 🎯 核心一句话

> **把六合彩选号策略转化为可回测、可复现、可量化风险收益的数学策略系统。**

---

## 1. 📝 项目背景

### 当前痛点

多数现有网站仅停留在基础数据展示层面，无法回答核心问题：

* ❌ 策略长期是否具备正数学期望？
* ❌ 极端情况下是否有爆仓风险？

### 平台解决方案

本平台通过 **统计分析** 与 **量化回测** 机制，将策略逻辑、玩法规则、赔率体系与资金管理深度整合，用严谨的数据验证策略的真实效果。

---

## 2. 👥 用户群体

| **用户类型** | **核心诉求** |
| --- | --- |
| **资深彩民** | 验证多年经验、口诀是否有效，查询冷热号及遗漏数据。 |
| **策略型用户** | 需要回测工具、参数调整功能，对比不同策略的优劣。 |
| **数据/量化爱好者** | 关注数学期望 (EV)、最大回撤 (MDD)、爆仓概率及风险控制。 |
| **普通用户** | 希望直观看到某个策略是“可行”还是“必输”。 |

---

## 3. ⚠️ 用户痛点分析

1. **效果不可知**：策略好坏全凭感觉，无法量化验证。
2. **数据分析弱**：缺乏多维度的遗漏和热度统计，难以发现数据规律。
3. **幸存者偏差**：只关注命中率，忽略了赔率劣势与资金管理的重要性。
4. **隐性风险**：高命中率策略往往隐藏着“一次归零”的爆仓风险。
5. **难以复现**：缺乏统一环境，回测结果无法被他人验证。

---

## 4. 🚀 产品目标

* 提供完整、可配置、可复现的 **策略回测环境**。
* 提供多维度的 **历史开奖统计分析**（遗漏、冷热）。
* 显式展示 **收益、回撤、连输、爆仓风险** 等关键量化指标。
* 支持 **玩法 + 赔率 + 资金管理 + 动态下注** 的自由组合。
* 支持 **年份生肖规则映射**，满足生肖类玩法的回测需求。

---

## 5. 💡 核心产品理念

---

## 6. 🧩 功能模块详细说明

### 6.1 💾 历史数据管理模块

* **功能**：Excel 导入（支持单文件多子表读取）、按年份自动分表、数据存储、**在线 API 同步**、数据展示。
* **特性**：
    * **多表合并**：导入时自动读取 Excel 内所有子表并合并。
    * **在线同步**：支持从 API 自动拉取最新历史数据，支持增量更新（默认当年）及历史全量补录。
    * **年份分组**：根据日期自动将数据存储为年度文件（如 `2024.feather`）以及全量汇总文件（`all.feather`）。
    * **自动解析**：自动计算并存储生肖、波色（红/蓝/绿）、单双属性；自动处理 `year` 字段的类型转换与容错机制。
    *   **Python 集成**：采用长连接 Sidecar 模式，通过 `NumpyEncoder` 解决 Python 对象与 JSON 的序列化兼容性问题。
    * **本地化存储**：数据存储在项目根目录的 `/data/history/` 下，确保数据透明可控。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `period` | string | 期号 (e.g., "001") |
| `date` | string | 开奖日期 (YYYY-MM-DD) |
| `n1...n6` | int | 正码 1~6 的原始数字 |
| `n1_zodiac...` | string | 对应位置的生肖 |
| `n1_color...` | string | 对应位置的波色 (red/blue/green) |
| `n1_odd...` | bool | 是否为单数 |
| `special` | int | 特码号码 |
| `special_zodiac` | string | 特码生肖 |
| `special_color` | string | 特码波色 |
| `special_odd`| bool | 特码单双 |

### 6.2 📊 历史开奖统计模块 (Historical Statistics) <span style="color:red">[NEW]</span>

* **功能**：基于历史数据，计算各维度的遗漏值（Omission）和热度值（Frequency）。
* **核心指标**：
* **当前遗漏**：距离上一次出现相隔的期数。支持 **特码尾数、大小、单双** 的实时遗漏统计。
* **历史最大遗漏**：历史上（或选定区间内）最大的遗漏期数。
* **热度/频率**：在选定区间（如近100期）出现的次数。
* **平均遗漏**：平均多少期出现一次。
* **其他特性**：
    *   **区间筛选**：支持“全部历史”或“近N期” (50/100/200/500) 筛选，精准分析近期热度。
    *   **年份筛选**：支持按特定年份缩小统计范围。



#### 6.2.1 统计维度定义

| 统计对象 | 支持属性 | 说明 |
| --- | --- | --- |
| **特码 (Special)** | 号码、生肖、波色、单双、大小、尾数 | **全维度统计**。特码是策略分析的核心。 |
| **正码 (Normal)** | 号码 | 仅统计 1~49 号码在正码位置的出现情况（不区分具体是第几个正码）。 |

#### 6.2.2 属性定义细则

* **号码**：01 ~ 49
* **生肖**：鼠 ~ 猪 (共12个，动态映射年份)
* **波色**：红波、蓝波、绿波
* **单双**：单 (Odd)、双 (Even)
* **大小**：大 (25-49)、小 (1-24) *(注: 49号的处理需可配置，默认归为大)*
* **尾数**：0尾 ~ 9尾 (如 12, 22, 32, 42 均为 2尾)

#### 6.2.3 输出形式

* 支持按“当前遗漏”降序排列（寻找冷号）。
* 支持按“出现频率”降序排列（寻找热号）。
* **数据结构示例**：
```json
{
  "target": "special_number",
  "dimension": "zodiac",
  "stats": [
    { "label": "龙", "current_omission": 5, "max_omission": 32, "frequency_100": 12 },
    { "label": "马", "current_omission": 0, "max_omission": 40, "frequency_100": 8 }
  ]
}

```



### 6.3 🎲 玩法配置模块 (PlayType)

* **功能**：定义“什么算赢”，支持嵌套玩法。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` | int | 唯一标识 |
| `name` | string | 玩法名称 |
| `hit_rule` | JSON | 命中判定规则（单双/大小/组合） |
| `min_selection` | int | 最少选号数量 |
| `max_selection` | int | 最大选号数量 |
| `allow_multiple_bet` | bool | 是否支持拆单 |

### 6.4 💰 赔率配置模块 (OddsProfile) ✅

* **功能**：定义玩法对应的收益模型，支持版本控制。**仅支持固定赔率**。
* **主要特性**：
    * **玩法映射**：支持 特码号码、波色、生肖、单双、大小 等基础玩法。
    * **版本管理**：支持多版本并存，记录生效时间区间。
    * **灵活性**：支持配置基础赔率、返水比例、单注收益封顶。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `id` | string | 唯一标识 (UUID) |
| `name` | string | 配置名称 |
| `play_type` | string | 玩法类型 (special_number/color/zodiac/...) |
| `odds` | float | 固定赔率 |
| `rebate` | float | 返水比例 |
| `max_payout` | float | 封顶收益 |
| `version` | string | 赔率版本号 |
| `valid_from/to` | date | 生效时间区间 |
| `create_time` | int | 创建时间戳 |

### 6.5 🚥 下注触发条件模块 (Entry Rule)

* **功能**：决定**是否下注**。支持多条件叠加 (AND/OR)。
* **数据源联动**：此模块直接调用 **6.2 统计模块** 的数据作为判断依据。
* **条件类型**：
* **遗漏 (Omission)**：如“特码双数连续遗漏 ≥ N 期”。
* **连中/连不中 (Streak)**。
* **窗口统计 (Window Stat)**：如“最近 20 期出现 ≤ 6 次”。



**DSL 示例：**

```json
{
  "rules": [
    {
      "type": "omission",
      "target": "special_number",
      "property": "parity", // 引用统计模块的单双属性
      "value": "even",
      "mode": "consecutive",
      "condition": { ">=": 5 }
    },
    {
      "type": "window_stat",
      "window": 20,
      "target": "special_number",
      "property": "parity",
      "value": "even",
      "condition": { "<=": 6 }
    }
  ],
  "operator": "AND"
}

```

### 6.6 📡 策略信号模块 (Signal)

* *(当前版本暂不需要，后续扩展为“决定下注具体内容”)*

### 6.7 💸 资金管理模块 (Bet Sizing)

* **功能**：资金分配策略。
* **模式**：固定 (Fixed) / 阶梯 (Dynamic) / 指数 (Exponential)。
* **特性**：支持 `reset_on_hit` (中奖后重置)。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `mode` | string | fixed / martingale / loss_recovery |
| `base_bet` | float | 基础注额 |
| `rules` | JSON | 阶梯规则详情 |
| `max_bet` | float | 最大注额（风控） |
| `reset_on_hit` | bool | 命中是否重置计数 |

### 6.8 ⚙️ 回测引擎

* **核心逻辑**：按期回放 → **调用统计模块更新状态** → 判断 Entry Rule → 结合玩法/赔率/资金 → 结算盈亏。
* **输出**：`BacktestEvent` 对象。

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `task_id` | int | 任务 ID |
| `period` | string | 期号 |
| `bet` | float | 本期投入 |
| `profit` | float | 本期盈亏（净利） |
| `hit` | bool | 是否命中 |

### 6.9 📊 回测指标与报告

* **核心指标**：胜率、总盈亏、EV (期望值)、最大连输/连赢、最大回撤、爆仓判定。
* **可视化**：资金曲线图、单期盈亏柱状图、盈亏分布（长尾风险）。
* **输出格式**：纯数据表格（无需生成图片文件）。


### 6.12 ⏯️ 手动/回放回测模式 (Manual/Replay Mode)

*   **功能**：模拟真实开奖过程，按期数逐条回放。
*   **特性**：
    *   **时间正序 (Chronological)**：回放必须按时间顺序进行（如 2000 -> 2001），内部逻辑基于历史遗漏预测未来。
    *   **数据源切换**：支持在回放页动态切换“全部历史”或“特定年份”数据源。
    *   **时间区间筛选**：支持通过日期选择器 (Date Picker) 进一步缩小回放范围。
*   **交互方式**：
    *   **手动 (Manual)**：用户点击“下一期”，系统推进一期。
    *   **自动 (Auto)**：系统按一定速度自动推进（支持 0.2s - 1.0s 间隔）。
*   **实时反馈与可视化**：
    *   **当期状态**：展示该期的开奖球、生肖、波色。
    *   **实时统计**：实时展示该期开出后的**全表遗漏值**（红/蓝/绿波、生肖遗漏）。
    *   **策略执行可视化 (Signal Evaluation)**：
        *   **条件拆解**：清晰列出策略中的每一项准入规则（如“遗漏 >= 5”）。
        *   **预测逻辑 (Prediction Logic)**：严格执行 **期数 T 预测 期数 T+1** 的逻辑。即利用当前已开奖期数 T 的统计数据，实时判定是否在下一期 T+1 进行下注。
        *   **PASS/FAIL 判定**：对比 **期数 T 的实际统计值** 与 **策略阈值**，实时展示信号是否触发。
        *   **界面显示重构**：
            *   **下注结果 (Bet Result)**：展示**本期 (Period T)** 开奖结果对上一期决策的结算情况（胜/负、盈亏金额、对应期号）。
            *   **下期下注 (Next Bet)**：展示基于本期数据生成的**下一期 (Period T+1)** 下注计划（下注目标、金额、目标期号）。
        *   **实时统计增强**：在回放界面显著展示 特码尾数、单双、大小 的遗漏与热度数据。
        *   **历史订单 (Historical Orders)**：支持查看当前回放进度之前的成交历史列表（期数、目标、金额、结果、盈亏），便于回查模拟表现。
        *   **多条件策略支持 (Multi-Condition)**：
            *   **逻辑组合**：支持多维度条件（如“生肖遗漏” AND “单双遗漏”）叠加判断。
            *   **智能目标锁定 (Smart Targeting)**：当多个条件同时满足触发时，系统根据维度特异性（Specificity Priority）自动锁定最佳下注目标。
                *   优先级：**号码 > 生肖 > 尾数 > 波色 > 单双/大小**。
                *   例如：同时满足“羊遗漏 > 10”和“单数遗漏 > 6”，系统自动判定下注目标为“羊”（赔率更高、更具体）。
        *   **鲁棒性增强**：
            *   **详细错误诊断**：若策略中包含无法映射的条件（如中文字符编码错误、缺失统计列），系统将返回具体的 `Missing Col: ...` 错误信息而非笼统报错。
        *   **性能保障**：通过 DataFrame 预处理优化，确保回放过程中策略实时计算的响应延迟 < 200ms，杜绝 15s 超时问题。

### 6.13 📂 数据源管理 (Data Management)

*   **功能**：策略工坊支持动态切换数据源（Feather 格式）。
*   **用途**：允许用户在不同年份的数据集或不同版本的数据间快速切换，无需重启应用。


### 6.11 🛡️ 风控与策略提示模块

* **功能**：自动扫描策略潜在风险，与资金管理联动。
* **提示示例**：

> ⚠️ **风险警告**
> * 当前策略数学期望为 **负**
> * 最大连输：**7 期**
> * 最大单注需：**80**
> * 当前本金 < 500，存在 **高爆仓风险**
> 
> 

---

## 7. 🗄️ 数据模型 (简化版)

* `HistoricalRecord`: { `period`, `date`, `n1`~`n6`, `special`, `*_zodiac`, `*_color`, `*_odd` }
* `StatisticsCache` (period, type, dimension, value, omission_count, frequency)
* `EntryRule` (id, name, description, conditions, logicOperator)
* `MoneyRule` (id, name, mode, params)
* `OddsProfile` (id, name, playType, odds, rebate, maxPayout, version, validFrom, validTo)
* `Strategy` (id, name, entryRuleId, moneyRuleId, oddsProfileId)
* `BacktestTask` (id, strategy_id, odds_id, bankroll, status)
* `BacktestEvent` (task_id, period, bet, profit, hit)

---

## 8. ✅ MVP 范围 (v2.5)

1. 历史数据管理（支持 Excel 多表导入，自动补全 `year` 字段）
2. **历史开奖统计分析（遗漏、冷热榜单）** ✅ (已完成)
3. **玩法 & 赔率配置 (支持多版本 CRUD)**
4. 下注触发条件 & 资金管理
5. 核心回测引擎 (支持动态赔率计算)
6. **可视化手动回放（支持策略条件穿透分析、新统计维度渲染、性能优化）** ✅
7. 年份生肖规则映射
8. 时间正序回测逻辑（Oldest -> Newest）
9. **下注规则编辑器优化（支持生肖/五行/尾数下拉选择、尾数维度扩展）** ✅

---

## 9. 🏁 验收标准

* **一致性**：同一策略 + 数据 + 赔率，多次回测结果必须完全一致。
* **数据准确性**：
* 统计模块计算的遗漏值需与主流彩票网站一致。
* 生肖/波色/单双/大小/尾数 仅对 **特码** 生效。
* 正码仅统计号码出现频率，不统计其他维度。


* **风控识别**：能准确识别高风险策略并给出文字提示。
* **生肖映射**：跨年份回测时，生肖映射逻辑自动切换准确。

---

## 10. 📢 产品定位总结

**让所有六合彩策略接受数学审判的量化回测系统。**